<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description"
    content="Lo stato del sovraffollamento nelle carceri Italiane, aggiornato con gli ultimi dati disponibili del Ministero.">
  <title>Mappa del sovraffollamento carcerario in Italia</title>
  <link rel="icon" href="prison.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <meta content="La mappa del sovraffollamento carcerario in Italia." property="og:site_name">
  <meta name="twitter:creator" content="@mdallastella">
  <meta name="twitter:title" content="La mappa del sovraffollamento carcerario in Italia.">
  <meta name="twitter:description"
    content="Lo stato del sovraffollamento nelle carceri Italiane, aggiornato con gli ultimi dati disponibili del Ministero.">
  <meta name="twitter:image" content="https://marcodallastella.github.io/prison_overcrowding/prison.png">
  <meta name="twitter:image:alt" content="A symbolic image of an overcrowded prison.">
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://marcodallastella.github.io/prison_overcrowding/">
  <meta property="og:title" content="La mappa del sovraffollamento carcerario in Italia.">
  <meta property="og:description"
    content="Lo stato del sovraffollamento nelle carceri Italiane, aggiornato con gli ultimi dati disponibili del Ministero.">
  <meta property="og:image" content="https://marcodallastella.github.io/prison_overcrowding/prison.png">
  <meta property="og:image:height" content="912">
  <meta property="og:image:width" content="921">
  <style>
    .hero {
      background-color: rgb(190, 207, 207);
    }


    .text-container {
      margin-left: 5%;
      margin-right: 5%;
      color: black;
    }

    .is-blank {
      background-color: white;
    }
  </style>
</head>

<body>

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MSZ7RZTEBS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MSZ7RZTEBS');
</script>
  <!-- Hero Section -->
  <section class="hero is-large">
    <div class="hero-body">
      <p class="title">I Numeri del Sovraffollamento Carcerario in Italia.</p>
      <p class="subtitle">Lo stato delle carceri in Italia. Aggiornato in tempo (quasi) reale con gli ultimi dati del
        Ministero.
      </p>
      <p class="subtitle is-6">A cura di <a href="https://marcodallastella.github.io/" target="_blank">Marco Dalla Stella.<a></p>
    </div>
  </section>

  <!-- Main Content Section -->
  <section class="section">
    <section class="hero is-medium is-blank">
      <div class="hero-body">
        <div class="text-container is-size-3">
          <p id="last-update" style="display: inline;"></p>
          <p id="detainees-count" style="display: inline;"></p>
          <p id="capacity-count" style="display: inline;"></p>
        </div>
        <br>
        <br>

        <!-- Iframe Container 1 -->
        <div class="iframe-container" id="chart-1">
          <iframe title="Detenuti presenti e Capienza Regolamentare" aria-label="Interactive line chart" id="datawrapper-chart-DaecH" src="https://datawrapper.dwcdn.net/DaecH/8/" scrolling="no" frameborder="0" style="width: 100%; min-width: 100% !important; border: none;" height="455" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(a){if(void 0!==a.data["datawrapper-height"]){var e=document.querySelectorAll("iframe");for(var t in a.data["datawrapper-height"])for(var r=0;r<e.length;r++)if(e[r].contentWindow===a.source){var i=a.data["datawrapper-height"][t]+"px";e[r].style.height=i}}}))}();
          </script>
        </div>
      </div>
    </section>
    <br>


    <section class="hero is-medium is-blank">
      <div class="hero-body">
        <div class="text-container is-size-3">
          <p id="overcrowding-rate" style="display: inline;"></p>
          <p id="unavailable-places" style="display: inline;"></p>
          <p id="recent-overcrowding-rate" style="display: inline;"></p>
        </div>
      </div>
    </section>
    <section class="hero is-medium is-blank">
      <div class="hero-body">
        <div class="text-container is-size-3">
          <p>
            La realtà però è spesso peggiore.
            <span id="overcrowded-prisons-count" style="display:inline;"></span>
            <span id="highest-overcrowding" style="display: inline;"></span>
          </p>
        </div>
        <br>
        <br>
        <div class="iframe-container" id="chart-2">
          <iframe title="Affollamento carcerario in Italia" aria-label="Map" id="datawrapper-chart-LfHlU" src="https://datawrapper.dwcdn.net/LfHlU/6/" scrolling="no" frameborder="0" style="width: 100%; min-width: 100% !important; border: none;" height="731" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(a){if(void 0!==a.data["datawrapper-height"]){var e=document.querySelectorAll("iframe");for(var t in a.data["datawrapper-height"])for(var r=0;r<e.length;r++)if(e[r].contentWindow===a.source){var i=a.data["datawrapper-height"][t]+"px";e[r].style.height=i}}}))}();
          </script>
        </div>
      </div>
    </section>

    <br>
    <br>


    <!-- Iframe Container 3 -->
    <div class="iframe-container" id="chart-3">
      <iframe title="Le Carceri più Sovraffollate d'Italia" aria-label="Tabella" id="datawrapper-chart-AVjKa" src="https://datawrapper.dwcdn.net/AVjKa/3/" scrolling="no" frameborder="0" style="width: 100%; min-width: 100% !important; border: none;" height="905" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(a){if(void 0!==a.data["datawrapper-height"]){var e=document.querySelectorAll("iframe");for(var t in a.data["datawrapper-height"])for(var r=0;r<e.length;r++)if(e[r].contentWindow===a.source){var i=a.data["datawrapper-height"][t]+"px";e[r].style.height=i}}}))}();
      </script>
    </div>
  </section>


  <section class="hero is-medium is-blank">
    <div class="hero-body">
      <div class="text-container is-size-3">
        <p style="color:black;">
          Scarica i dati
        </p>
        <ul style="font-size: 0.6em; list-style-type: disc; padding-left: 2rem;">
          <li>
            <a href="https://github.com/marcodallastella/prison_overcrowding/blob/main/outputs/clean/institutes.csv" target="_blank">Dati
              schede trasparenza istituti penitenziari</a> (da 5 ottobre 2024)
          </li>
          <li>
            <a href="https://github.com/marcodallastella/sovraffollamento_carcerario/blob/main/outputs/viz/institutes_totals.csv" target="_blank">Dati schede trasparenza istituti penitenziari, totali giornalieri</a> (da 5 ottobre 2024)
          </li>
          <li>
            <a href="https://github.com/marcodallastella/prison_overcrowding/blob/main/outputs/clean/bulletines.csv" target="_blank">Dati
              bollettini mensili, per istituto penitenziario</a> (da gennaio 2019)
          </li>
          <li>
            <a href="https://github.com/marcodallastella/sovraffollamento_carcerario/blob/main/outputs/viz/bulletines_totals.csv" target="_blank">Dati
              bollettini mensili, totali mensili</a> (da gennaio 2019)
          </li>
        </ul>
      </div>
      <br><br>
    </div>
  </section>
  


  <footer class="footer">
    <div class="content has-text-centered">
      <p>
        Questo è un progetto di <a href="https://marcodallastella.github.io/" target="_blank">Marco Dalla Stella</a>, data journalist
        radicato a Brooklyn, NY. <br>
        Il codice utilizzato per l'ottenimento e l'elaborazione dei dati è disponibile su
        <a href="https://github.com/marcodallastella/prison_overcrowding" target="_blank">GitHub</a>.<br>
        Per suggerimenti, critiche o osservazioni, scrivere a <a
          href="mailto:md3934@columbia.edu">md3934@columbia.edu</a>. <br>Se pensi che questo progetto sia utile,
        considera la possibilità di <a href="https://www.buymeacoffee.com/marcodallastella" target="_blank">offrirmi un caffè</a>.
      </p>
    </div>
  </footer>



  <script>
    async function fetchData() {
      const response = await fetch('https://raw.githubusercontent.com/marcodallastella/prison_overcrowding/refs/heads/main/outputs/viz/bulletines_totals.csv');
      const data = await response.text();
      const rows = data.split('\n');
      const lastRow = rows[rows.length - 2]; // Get the last data row (excluding empty last line)
      const columns = lastRow.split(',');

      // Get the last update date from the first column
      const lastUpdateDate = columns[0].trim(); // Assuming the first column contains the date

      // Format the date to Italian format
      const formattedDate = new Intl.DateTimeFormat('it-IT', { day: 'numeric', month: 'long', year: 'numeric' }).format(new Date(lastUpdateDate));


      // Assuming the "Detenuti presenti - totale" is the third last column and "Capacità" is the second last column
      const detaineesCount = columns[columns.length - 4].replace(/\./g, '').replace(',', '.'); // Clean the number format
      const numberCount = parseFloat(detaineesCount); // Convert to float

      // Format the detainees count with dot as thousands separator
      const formattedCount = numberCount.toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).replace(/,/g, '.');

      // Fetch capacity
      const capacity = columns[columns.length - 5].replace(/\./g, '').replace(',', '.'); // Clean the capacity format
      const formattedCapacity = parseFloat(capacity).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).replace(/,/g, '.');

      // Fetch overcrowding rate
      const overcrowdingRate = columns[columns.length - 1]; // Do not remove any dots here
      const formattedRate = parseFloat(overcrowdingRate.replace(',', '.')).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });



      // Update the HTML to show the number of detainees and capacity
      document.getElementById('detainees-count').innerText = `${formattedCount}`;
      document.getElementById('capacity-count').innerText = `a fronte di ${formattedCapacity} posti disponibili.`;
      document.getElementById('last-update').innerText = `Al ${formattedDate} i detenuti presenti in Italia erano`; // Display last update date
      document.getElementById('overcrowding-rate').innerText = `Ufficialmente, nelle carceri italiane ci sono quindi ${formattedRate} persone per ogni 100 posti disponibili.`;


      // Fetch data from the second CSV file
      const response2 = await fetch('https://raw.githubusercontent.com/marcodallastella/prison_overcrowding/refs/heads/main/outputs/viz/institutes_totals.csv');
      const data2 = await response2.text();
      const rows2 = data2.split('\n');

      // Assuming the first row contains the header
      const headers2 = rows2[0].split(',');

      // Find the column indices for `tasso_sovraffollamento` and `posti_non_disponibili`
      const indexOvercrowdingRate = headers2.indexOf('tasso_sovraffollamento');
      const indexUnavailablePlaces = headers2.indexOf('posti_non_disponibili');

      // Get the data from the most recent row
      const lastRow2 = rows2[rows2.length - 2].split(',');

      // Fetch specific data points
      const latestOvercrowdingRate = parseFloat(lastRow2[indexOvercrowdingRate].replace(',', '.')).toLocaleString('it-IT', { minimumFractionDigits: 2 });
      const unavailablePlaces = parseInt(lastRow2[indexUnavailablePlaces], 10).toLocaleString('it-IT');

      // Update HTML elements with the new data
      document.getElementById('recent-overcrowding-rate').innerText = `Questo fa si che il reale tasso di sovraffollamento sia del ${latestOvercrowdingRate} %.`;
      document.getElementById('unavailable-places').innerText = `Ma si tratta di una stima al ribasso, dato che questo dato non tiene conto dei ${unavailablePlaces} posti che, per un motivo o per l'altro, non sono disponibili.`;

      // Fetch data from the third CSV file (institutes_most_recent.csv)
      const response3 = await fetch('https://raw.githubusercontent.com/marcodallastella/prison_overcrowding/refs/heads/main/outputs/viz/institutes_most_recent.csv');
      const data3 = await response3.text();
      const rows3 = data3.split('\n');
      const headers3 = rows3[0].split(',');

      const indexAffollamento = headers3.indexOf('tasso_affollamento');
      const indexNome = headers3.indexOf('nome');

      // Find the highest `tasso_affollamento`
      let highestAffollamento = 0;
      let highestAffollamentoNome = '';
      let overcrowdedPrisonCount = 0; // Initialize counter for overcrowded prisons

      for (let i = 1; i < rows3.length - 1; i++) {
        const row = rows3[i].split(',');
        const currentAffollamento = parseFloat(row[indexAffollamento].replace(',', '.'));

        // Check for the highest overcrowding rate
        if (currentAffollamento > highestAffollamento) {
          highestAffollamento = currentAffollamento;
          highestAffollamentoNome = row[indexNome];
        }

        // Count prisons with `tasso_affollamento` >= 1.5
        if (currentAffollamento >= 150) {
          overcrowdedPrisonCount++;
        }
      }

      // Format the highest overcrowding rate and update HTML
      const formattedHighestAffollamento = highestAffollamento.toLocaleString('it-IT', { minimumFractionDigits: 2 });
      document.getElementById('highest-overcrowding').innerText = `La situazione più grave si registra a ${highestAffollamentoNome}, dove il sovraffollamento è del ${formattedHighestAffollamento}%.`;

      // Update HTML with the count of overcrowded prisons
      document.getElementById('overcrowded-prisons-count').innerText = `In ${overcrowdedPrisonCount} istituti penitenziari il tasso di affollamento è pari o superiore al 150% (tre persone ogni due posti disponibili).`;
    }



    // Fetch the detainees count and capacity when the page loads
    window.onload = fetchData;


  </script>
</body>

</html>